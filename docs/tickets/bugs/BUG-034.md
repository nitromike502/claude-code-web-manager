# BUG-034: YAML Parse Errors in Local Agent Files

**Status:** Reported
**Severity:** Medium
**Component:** Backend Parser (subagentParser.js)
**Affected Scope:** User-level agents with `.local.md` extension

---

## Issue Description

The backend is logging repeated YAML parse errors when scanning user-level agent files, specifically files with the `.local.md` extension:

```
Warning: YAML parse error in /home/claude/claude-code-training/.claude/agents/claude-code-trainer.local.md:
incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line at line 3, column 166:
     ... on-technical audiences. Examples: <example>Context: User needs t ...
```

This suggests that `.local.md` files may have:
1. **Malformed YAML frontmatter** that gray-matter can't parse
2. **YAML syntax issues** (missing colons, improper indentation, or unclosed quotes)
3. **Invalid characters** in the YAML that conflict with YAML syntax

---

## Root Cause Analysis

**Current Behavior:**
- Backend encounters `.local.md` file with invalid YAML
- `gray-matter` throws a YAML parsing error
- Error is caught and logged as a warning
- Subagent is still created with minimal data and `parseError` field set

**Why This Happens:**
- Users may manually edit `.local.md` files without validating YAML syntax
- YAML frontmatter might have line breaks in strings without proper quoting
- Special characters (`:`, `#`, `>`) might not be properly escaped

---

## Impact

**Current:** Medium
- Backend continues to function (errors are caught and handled)
- Subagents are still discoverable (though with incomplete data)
- Users don't see the issue in the UI (warnings are only in server logs)

**Potential Future Impact:**
- If UI starts displaying `parseError` field, users will see "Error parsing YAML frontmatter"
- May cause confusion about which agents are valid vs. broken

---

## Example Affected File

File: `/home/claude/claude-code-training/.claude/agents/claude-code-trainer.local.md`

**Likely Issue:**
The YAML frontmatter probably has a multiline string value without proper quoting, e.g.:
```yaml
description: Examples: <example>Context: User needs to do something, here's how...
```

Should be:
```yaml
description: "Examples: <example>Context: User needs to do something, here's how...</example>"
```

---

## Test Case

**Scenario:** Parse a `.local.md` file with malformed YAML

**Input:** File with YAML like:
```yaml
---
name: test-agent
description: This has a colon: and special chars # and > without proper quotes
---
System prompt content
```

**Expected Behavior:**
- Parser catches the YAML error gracefully
- Returns agent object with `hasError: true` and `parseError` field populated
- Doesn't crash or prevent other agents from being parsed
- Warning is logged (current behavior is correct)

**Current Behavior:**
- ✅ Error is caught and logged
- ✅ Other agents continue to parse
- ❌ No indication in UI that agent has parse error

---

## Files to Review

1. **Backend Parser:** `/home/claude/manager/src/backend/parsers/subagentParser.js`
   - Line 24-44: YAML error handling
   - Verify that `parseError` is being set correctly

2. **User Agent Files:** Check for `.local.md` files with invalid YAML
   - `/home/claude/claude-code-training/.claude/agents/*.local.md`
   - Validate YAML syntax in these files

3. **Frontend Component:** UserGlobal.vue or ProjectDetail.vue
   - Consider displaying parse error warnings if agent has `hasError: true`

---

## Suggested Fix

### Option 1: Validate Before Parsing (Recommended)
Add YAML syntax validation before attempting to parse:
```javascript
// Validate YAML syntax without throwing
try {
  YAML.parse(frontmatterText);
} catch (validationError) {
  // Log detailed error
  console.warn(`YAML validation failed in ${filePath}: ${validationError.message}`);
  // Return partial agent with error flag
}
```

### Option 2: Display UI Warning
Show `parseError` field in frontend UI when agent has `hasError: true`

### Option 3: Auto-Fix Common Issues
Strip quotes from line-containing YAML values or use JSON-compatible escaping

---

## Next Steps

1. **Determine Scope:** Are there other `.local.md` files with similar issues?
2. **User Communication:** Determine if users need guidance on valid YAML syntax for `.local.md` files
3. **Frontend Enhancement:** Add UI indicator for agents with parse errors
4. **Validation Tool:** Consider adding a lint/validation command for `.local.md` files

---

## Related Tickets

- BUG-027: Agent Color Display (parent bug affecting sidebar display)
- BUG-028 through BUG-033: Related agent/command/hook field display issues

---

## Metadata

- **Created:** October 24, 2025
- **Created By:** Code investigation during manual testing
- **Priority:** Medium (non-blocking, but should be tracked)
- **Effort:** 2-3 hours (validation + UI display)
